# ============================================================================
# Pi Remote Access Stack — Docker Compose
# ============================================================================
# Zero-Trust secure remote access for Raspberry Pi 5:
#   - Tailscale    → private VPN, subnet router, SSH (outbound only)
#   - Cloudflared  → public web exposure via Cloudflare Tunnels (outbound only)
#
# ZERO inbound ports opened on the home router.
# Both services establish encrypted outbound tunnels.
#
# Usage:
#   docker compose up -d
#   docker compose logs -f
#   docker compose down
# ============================================================================

services:
  # --------------------------------------------------------------------------
  # Tailscale — Private VPN + Subnet Router + SSH
  # --------------------------------------------------------------------------
  # Establishes an outbound WireGuard tunnel to the Tailscale network.
  # Advertises your home LAN subnet so you can access all Pi services
  # from your work laptop anywhere in the world.
  # --------------------------------------------------------------------------
  tailscale:
    image: tailscale/tailscale:latest
    container_name: tailscale
    hostname: ${TAILSCALE_HOSTNAME:-pi5}
    restart: unless-stopped
    environment:
      # Auth key from https://login.tailscale.com/admin/settings/keys
      TS_AUTHKEY: ${TAILSCALE_AUTHKEY:?TAILSCALE_AUTHKEY is required — generate at login.tailscale.com/admin/settings/keys}

      # Subnet router — advertise home LAN for full access
      TS_EXTRA_ARGS: >-
        --advertise-routes=${LAN_SUBNET:-192.168.1.0/24}
        --accept-dns=false
        --ssh

      # Persist identity across reboots
      TS_STATE_DIR: /var/lib/tailscale

      # Run as userspace networking (no kernel module needed)
      TS_USERSPACE: "false"
    volumes:
      # Persistent Tailscale state (node identity, keys)
      - tailscale_state:/var/lib/tailscale
      # /dev/net/tun is required for kernel-mode networking
      - /dev/net/tun:/dev/net/tun
    cap_add:
      - NET_ADMIN
      - NET_RAW
      - SYS_MODULE
    sysctls:
      - net.ipv4.ip_forward=1
      - net.ipv6.conf.all.forwarding=1
    healthcheck:
      test: ["CMD-SHELL", "tailscale status --json | grep -q '\"BackendState\":\"Running\"' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - remote_access_net
    deploy:
      resources:
        limits:
          memory: 128M

  # --------------------------------------------------------------------------
  # Cloudflared — Public Web Exposure via Cloudflare Tunnels
  # --------------------------------------------------------------------------
  # Establishes an outbound encrypted tunnel to Cloudflare's edge network.
  # Routes public subdomains to internal Docker services — zero inbound ports.
  # --------------------------------------------------------------------------
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel --config /etc/cloudflared/config.yml run
    environment:
      TUNNEL_TOKEN: ${CLOUDFLARE_TUNNEL_TOKEN:-}
      TZ: ${TZ:-Asia/Riyadh}
    volumes:
      # Tunnel configuration (ingress rules)
      - ./cloudflared/config.yml:/etc/cloudflared/config.yml:ro
      # Persistent credentials & cert
      - cloudflared_data:/etc/cloudflared/creds
    depends_on:
      tailscale:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "cloudflared tunnel info 2>&1 | grep -qiE 'connector|running' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    networks:
      - remote_access_net
    # Extra hosts allows cloudflared to reach services on the Pi host
    extra_hosts:
      - "host.docker.internal:host-gateway"
    deploy:
      resources:
        limits:
          memory: 128M

# ----------------------------------------------------------------------------
# Volumes — persistent state across reboots
# ----------------------------------------------------------------------------
volumes:
  tailscale_state:
    driver: local
  cloudflared_data:
    driver: local

# ----------------------------------------------------------------------------
# Network — isolated bridge for remote access containers
# ----------------------------------------------------------------------------
networks:
  remote_access_net:
    driver: bridge
